# Repository Guidelines

## Project Structure & Module Organization

- Source code: `src/` (entry: `src/app.ts`), shared types in `src/types/`.
- Build output: `dist/` (generated by `tsc`).
- Config: `tsconfig.json`, package scripts in `package.json`.
- Tests: not yet configured; prefer `tests/` with `*.spec.ts`.

## Build, Test, and Development Commands

- Install dependencies: `npm ci` (or `npm install` for local development).
- Build TypeScript: `npm run build` (emits to `dist/`).
- Run compiled app: `npm start` (executes `node dist/app.js`).
- Quick dev run (no build): `npx ts-node src/app.ts`.
- Tests: `npm test` currently a placeholder; see Testing Guidelines to add real tests.

## Coding Style & Naming Conventions

- TypeScript strict mode enabled; favor explicit types at module boundaries.
- Indentation: 2 spaces; include semicolons; single quotes or consistent style.
- Naming: `camelCase` for variables/functions, `PascalCase` for types/classes, `UPPER_SNAKE_CASE` for constants.
- File names: `kebab-case.ts` (e.g., `user-service.ts`); index files allowed for small barrels.
- Imports: relative within `src/`; avoid deep relative chains by reorganizing modules rather than path aliases.

## Validation, Typing, and Routing

- Validate all external input with Zod. Schemas live in `src/schemas/` (e.g., `src/schemas/player.ts`, `src/schemas/match.ts`, `src/schemas/import.ts`). Extend there when adding new endpoints.
- Use `validateRequest` middleware from `src/middleware/validate.ts` to parse/validate `body`/`query`/`params`; prefer `safeParse` + middleware-level errors over inline `if` checks.
- Routes are factories under `src/routes/` exposing `createXRouter` (players, clubs, seasons, teams, matches, game-events, health, import, insights, dashboard). Inject dependencies for tests; default export wires real deps.
- Keep controllers/services/repositories typed: reuse Prisma types at boundaries, domain DTOs in services, and Zod-inferred types from schemas when consuming request data.
- Fes el codi llegible i curt: posa noms semàntics a helpers i dades (p.ex. `parsePagination`, `mapMatchIssue`), extreu blocs lògics repetits a funcions petites, i evita lògica inline en controllers/rutes. Reutilitza helpers en tests per mantenir els casos descriptius.
- Quan afegeixis nova lògica d’estat (p.ex. bloqueig de partits, cronòmetres, càlcul de marcador), encapsula-la en helpers/estratègies amb nom i valida via esquemes Zod; mapeja errors a constants/strings reutilitzables per evitar literals “màgics”.
- Per a entrades batch (imports, assignacions), valida el contenidor i després cada element amb els mateixos esquemes que els endpoints normals; no retornis 400 global per un error puntual: acumula errors per element amb missatges consistents.
- Optimitza consultes Prisma: usa `select` per retornar només els camps necessaris (evita `include` profund) i, si cal, crea helpers/repositories específics per a vistes de lectura. Quan necessitis múltiples validacions d’existència, prefereix un sol `findMany` amb `in` o `select` acotat abans que múltiples crides. Documenta als tests les expectatives de `select`.

## Engineering Principles

- Follow SOLID principles; keep modules small, cohesive, and loosely coupled.
- Prefer established design patterns where they clarify intent (e.g., Strategy, Factory, Dependency Injection).
- All new code must include unit tests; update or add tests when modifying behavior.
- Verify all new features are covered by tests.
- Do not accept a feature as complete until all tests pass.
- Add intent comments sparingly to capture why code is shaped this way (functional rationale, engineering trade-offs, chosen flows), so readers understand decisions when revisiting.
- Frontend: qualsevol text nou de UI ha de provenir de l’arxiu de traducciones (`frontend/src/i18n/translations.ts`) i consumit via els hooks de llenguatge; evita literals incrustats en components.

## Testing Guidelines

- Suggested stack: Vitest or Jest with `ts-jest`/ESM support.
- Location: place tests under `tests/` mirroring `src/` structure; name as `*.spec.ts`.
- Coverage: target 80%+ lines/branches for new or modified code.
- Commands example: add `"test": "vitest"`, `"test:watch": "vitest --watch"` to `package.json`.

## Commit & Pull Request Guidelines

- Use Conventional Commits: `feat:`, `fix:`, `docs:`, `chore:`, `refactor:`, `test:`, `build:`.
- Limit subject to ~72 chars; include a concise body explaining rationale and impacts.
- PRs must include: clear description, linked issue (if any), before/after notes, and steps to verify (commands, endpoints).
- Keep PRs focused and small; include updates to docs/tests for changed behavior.

## Arquitectura, SOLID i TDD

To keep the project sustainable and easy to change and test, follow these concrete rules:

1. File structure and tests alongside code

- Keep tests near the code they cover. Ideal: tests next to the module (`src/module/x.ts` and `src/module/x.spec.ts` or `src/module/__tests__/x.spec.ts`). This eases refactors and ensures artifacts that change together live together.

2. SOLID and design patterns

- Follow SOLID to keep responsibilities clear. When a pattern improves separation of concerns or testability (e.g., Strategy to vary behaviors, Factory to create dependencies), use it and add a PR note explaining why.

3. Reuse and factorization

- Avoid duplication: extract common utilities/components into reusable modules. Prefer composition over inheritance whenever possible.

4. TDD and coverage

- Work in TDD mode: write automated tests before implementing. Cover critical units and integration flows. For new or changed areas, target high coverage (recommended 85–90% for the affected area).

5. Test types and tooling

- Unit tests: Vitest for frontend and backend isolated code.
- Integration/API: Supertest + Vitest to validate routes and Prisma/DB integrations.
- E2E: add a solution when flows require it (optional).
- CI: ensure the pipeline runs `prisma generate` if needed and executes tests with the same setup as local (`npm ci && npm test`).

6. PRs and verification

- In the PR include: how to test locally, which tests were added, and a justification if a design pattern was applied. Do not close the PR until all tests pass and required coverage is met for modified files.

## Security & Configuration

- Configuration via env vars (e.g., `PORT`). Use a local `.env` and never commit secrets.
- Node 18+ recommended. Run `npm ci` for reproducible installs.
- Ignore generated artifacts in VCS (`dist/`, logs). Keep `src/` the single source of truth.

## Issue Templates & Follow-Up

- Templates:
  - Supertest: `.github/ISSUE_TEMPLATE/millora-supertest.md`
  - Husky + lint-staged: `.github/ISSUE_TEMPLATE/millora-husky-lint-staged.md`
- Use: on GitHub, New issue → pick the template, assign an owner, adjust acceptance criteria.

## Local Guides

- Carpeta `src/repositories/AGENTS.md`: instruccions específiques per optimitzar consultes (ús de `select`, evitar `include` profund, tests de `select`).
- Carpeta `src/controllers/AGENTS.md`: validació amb Zod, mètodes curts, gestió d’errors i dependències injectades.
- Carpeta `tests/AGENTS.md`: ús de factories, verificació de queries i wiring, cobertura de validacions i patrons de mocks.
